<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Server Monitoring Dashboard - Vue.js</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
  <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
  <style>
    body {
      background-color: #f8f9fa;
    }

    #app {
      transition: opacity 0.5s;
    }

    .server-card {
      border-radius: 10px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      margin-bottom: 20px;
      background-color: #ffffff;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      height: 100%;
    }

    .server-card .card-header {
      background-color: #007bff;
      color: white;
      font-weight: bold;
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 15px;
      font-size: 1.25rem;
    }

    .server-card.status-error .card-header {
      background-color: #dc3545;
    }

    .server-card .card-body {
      padding: 15px;
      flex-grow: 1;
      background-color: #ffffffee;
      color: black;
    }

    .status-badge {
      font-size: 1.1em;
      padding: 5px 10px;
      border-radius: 5px;
    }

    .status-ok {
      background-color: #28a745;
      color: white;
    }

    .status-error {
      background-color: #dc3545;
      color: white;
    }

    .status-warning {
      background-color: #ffc107;
      color: #343a40;
    }

    .status-loading {
      background-color: #6c757d;
      color: white;
    }

    .metric-item {
      margin-bottom: 8px;
    }

    .metric-item strong {
      display: inline-block;
      width: 80px;
      font-weight: 600;
    }

    .progress {
      height: 15px;
      font-size: 0.75rem;
      margin-top: 5px;
    }

    .timestamp {
      font-size: 0.8em;
      color: #6c757d;
      border-top: 1px solid #eee;
      padding-top: 10px;
      margin-top: 15px;
    }

    .metric-column {
      border-left: 1px solid #eee;
      padding-left: 15px;
    }

    .metric-column:first-child {
      border-left: none;
    }

    .metric-column h4 {
      font-size: 1rem;
      margin-bottom: 10px;
      color: #495057;
    }

    .log-pre {
      background-color: #e9ecef;
      padding: 8px;
      border-radius: 5px;
      overflow: auto;
      white-space: pre-wrap;
      word-wrap: break-word;
      font-size: 0.8em;
      max-height: 150px;
      min-height: 50px;
    }

    .loading-placeholder {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 200px;
      color: #6c757d;
    }
  </style>
</head>

<body>

  <div id="app" class="container-fluid">
    <div class="d-flex align-items-center mb-4">
      <button v-if="selectedServer" @click="selectedServer = null" class="btn btn-outline-secondary me-3">
        <i class="fa-solid fa-arrow-left"></i> Back
      </button>
      <h1 class="text-center flex-grow-1 m-0">
        {{ selectedServer ? selectedServer.name : 'Server Monitoring Dashboard' }}
      </h1>
    </div>

    <div v-if="!selectedServer" class="row">
      <div v-for="server in servers" :key="server.name" class="col-sm-6 col-md-3 my-2">
        <div class="card server-card" :class="{ 'status-error': server.data && server.data.status === 'ERROR' }">
          <div class="card-header">
            <span>{{ server.name }}</span>
            <span class="status-badge" :class="getStatusClass(server)">
              {{ getStatusText(server) }}
            </span>
          </div>
          <div class="card-body d-flex flex-column">
            <div v-if="server.isLoading" class="loading-placeholder">
              <div class="spinner-border spinner-border-sm" role="status"></div>
            </div>
            <div v-else class="flex-grow-1">
              <div class="metric-item"><strong>Load Avg:</strong> <span>{{ getLoadAvg(server.data) }}</span></div>
              <div class="metric-item"><strong>Memory:</strong>
                <div class="progress" role="progressbar" :title="`Used: ${getMemoryInfo(server.data).used}`">
                  <div class="progress-bar" :class="getProgressBarClass(getMemoryInfo(server.data).percent)"
                    :style="{ width: getMemoryInfo(server.data).percent + '%' }">
                    {{ getMemoryInfo(server.data).percent }}%
                  </div>
                </div>
              </div>
              <div class="metric-item"><strong>Disk:</strong>
                <div v-for="disk in getStorageList(server.data)" :key="disk.mountPoint" class="metric-item">
                  <div v-if="!disk.mountPoint.startsWith('/boot')" class="progress" role="progressbar"
                    :title="`${disk.mountPoint}: ${disk.used} of ${disk.total}`">
                    <div class="progress-bar" :class="getProgressBarClass(disk.percent)"
                      :style="{ width: disk.percent + '%' }">
                      {{ disk.percent }}%
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <button class="btn btn-sm btn-outline-primary w-100 mt-auto" @click="selectServer(server)"
              :disabled="!server.data">
              View Full Info
            </button>
          </div>
        </div>
      </div>
    </div>

    <div v-else>
      <div class="card server-card">
        <div class="card-body">
          <div v-if="selectedServer.data" class="row">
            <div class="col-md-3 metric-column">
              <h4>System Metrics</h4>
              <div class="metric-item"><strong>Load Avg:</strong> <span>{{ getLoadAvg(selectedServer.data) }}</span>
              </div>
              <div class="metric-item"><strong>Memory:</strong>
                <div class="progress" role="progressbar"
                  :title="`Used: ${getMemoryInfo(selectedServer.data).used}, Total: ${getMemoryInfo(selectedServer.data).total}`">
                  <div class="progress-bar" :class="getProgressBarClass(getMemoryInfo(selectedServer.data).percent)"
                    :style="{ width: getMemoryInfo(selectedServer.data).percent + '%' }">
                    {{ getMemoryInfo(selectedServer.data).percent }}%
                  </div>
                </div>
              </div>
              <h4>Storage</h4>
              <div v-for="disk in getStorageList(selectedServer.data)" :key="disk.mountPoint" class="metric-item">
                <strong>{{ disk.mountPoint }}</strong>
                <div class="progress" role="progressbar" :title="`Used: ${disk.used}, Total: ${disk.total}`">
                  <div class="progress-bar" :class="getProgressBarClass(disk.percent)"
                    :style="{ width: disk.percent + '%' }">
                    {{ disk.percent }}%
                  </div>
                </div>
              </div>
              <div class="metric-item"><strong>Quota:</strong>
                <pre class="log-pre">{{ formatLog(selectedServer.data.logs.quota) }}</pre>
              </div>
            </div>
            <div class="col-md-3 metric-column">
              <h4>CPU & Mem Info</h4>
              <pre class="log-pre">{{ formatLog(selectedServer.data.logs.cpuinfo) }}</pre>
              <pre class="log-pre mt-2">{{ formatLog(selectedServer.data.logs.meminfo) }}</pre>
            </div>
            <div class="col-md-3 metric-column">
              <h4>Nginx & Named</h4>
              <pre class="log-pre">{{ formatLog(selectedServer.data.logs.nginx) }}</pre>
              <pre class="log-pre mt-2">{{ formatLog(selectedServer.data.logs.named) }}</pre>
            </div>
            <div class="col-md-3 metric-column">
              <h4>FPM Status</h4>
              <pre class="log-pre">{{ formatLog(selectedServer.data.logs.fpms) }}</pre>
            </div>
            <div class="col-12 timestamp mt-3 text-end">{{ formatTimestamp(selectedServer.data.timestamp) }}</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const { createApp, ref, onMounted } = Vue;

    createApp({
      setup() {
        // --- Reactive State ---
        const servers = ref([
          { name: "sgx.domcloud.co", endpoint: "https://sgx.domcloud.co/status/test", data: null, error: null, isLoading: true },
          { name: "wdc.domcloud.co", endpoint: "https://wdc.domcloud.co/status/test", data: null, error: null, isLoading: true },
          { name: "nue.domcloud.co", endpoint: "https://nue.domcloud.co/status/test", data: null, error: null, isLoading: true },
          { name: "sgp.domcloud.co", endpoint: "https://sgp.domcloud.co/status/test", data: null, error: null, isLoading: true },
          { name: "mnz.domcloud.co", endpoint: "https://mnz.domcloud.co/status/test", data: null, error: null, isLoading: true },
          { name: "osk.domcloud.co", endpoint: "https://osk.domcloud.co/status/test", data: null, error: null, isLoading: true },
          { name: "sao.domcloud.co", endpoint: "https://sao.domcloud.co/status/test", data: null, error: null, isLoading: true }
        ]);
        const initialLoadComplete = ref(false);
        const selectedServer = ref(null); // Holds the server object for the detail view

        // --- Methods ---
        const fetchServerStatus = async (server) => {
          server.isLoading = true;
          server.error = null;
          try {
            const response = await fetch(server.endpoint);
            if (!response.ok) {
              server.error = true;
            }
            server.data = await response.json();
          } catch (err) {
            server.error = err.message;
            server.data = null;
          } finally {
            server.isLoading = false;
          }
        };

        const initializeDashboard = () => {
          const fetchPromises = servers.value.map(s => fetchServerStatus(s));
          Promise.allSettled(fetchPromises).then(() => initialLoadComplete.value = true);
        };

        const selectServer = (server) => {
          selectedServer.value = server;
        };

        // --- Helpers for Template ---
        const getStatusText = (server) => {
          if (server.isLoading) return 'LOADING';
          if (server.error) return 'ERROR';
          return server.data?.status || 'UNKNOWN';
        };

        const getStatusClass = (server) => {
          const status = getStatusText(server);
          return {
            'status-ok': status === 'OK',
            'status-error': status === 'ERROR',
            'status-warning': !['OK', 'ERROR', 'LOADING'].includes(status),
            'status-loading': status === 'LOADING'
          };
        };

        const getLoadAvg = (data) => {
          const line = data?.logs?.cpuinfo?.[0] || '';
          const match = line.match(/load average: ([\d. ,]+)/);
          return match ? match[1] : 'N/A';
        };

        const parseSizeToGB = (str) => {
          if (!str) return 0;
          const val = parseFloat(str.replace(/[^0-9.]/g, ''));
          if (str.toLowerCase().includes('ki')) return val / 1048576;
          if (str.toLowerCase().includes('mi')) return val / 1024;
          if (str.toLowerCase().includes('gi')) return val;
          return val / 1073741824; // Bytes
        };

        const getMemoryInfo = (data) => {
          const line = data?.logs?.meminfo?.[1] || '';
          const vals = line.split(/\s+/).filter(Boolean);
          if (vals.length < 3) return { percent: 0, used: 'N/A', total: 'N/A' };
          const [totalStr, usedStr] = [vals[1], vals[2]];
          const percent = parseSizeToGB(totalStr) > 0 ? ((parseSizeToGB(usedStr) / parseSizeToGB(totalStr)) * 100).toFixed(0) : 0;
          return { percent, used: usedStr, total: totalStr };
        };

        const getStorageList = (data) => {
          const storageLogs = data?.logs?.storage;
          if (!Array.isArray(storageLogs) || storageLogs.length === 0) {
            return []; // Return empty array if no data
          }

          return storageLogs
            .map(line => {
              const parts = line.split(/\s+/).filter(Boolean);
              if (parts.length < 6) return null; // Ignore invalid or header lines

              // Assumes format: Filesystem Size Used Avail Use% Mounted on
              const mountPoint = parts[parts.length - 1];
              const percent = parseFloat(parts[parts.length - 2]) || 0;
              const used = parts[parts.length - 4];
              const total = parts[parts.length - 5];

              return { mountPoint, percent, used, total };
            })
            .filter(Boolean); // Filter out any null entries from invalid lines
        };
        const getProgressBarClass = (percent) => {
          if (percent > 80) return 'bg-danger';
          if (percent > 60) return 'bg-warning';
          return 'bg-success';
        };

        const formatLog = (logData) => {
          if (!logData) return 'N/A';
          if (Array.isArray(logData)) return logData.join('\n');
          return logData.toString();
        };

        const formatTimestamp = (ts) => ts ? `Last updated: ${new Date(ts).toLocaleString()}` : '';

        // --- Lifecycle Hook ---
        onMounted(initializeDashboard);

        // --- Expose to Template ---
        return {
          servers,
          initialLoadComplete,
          selectedServer,
          selectServer,
          getStatusText,
          getStatusClass,
          getLoadAvg,
          getMemoryInfo,
          getStorageList,
          getProgressBarClass,
          formatLog,
          formatTimestamp
        };
      }
    }).mount('#app');
  </script>

</body>

</html>